local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- Configuration
local AUTO_SHOOT_ENABLED = true -- Toggle auto-shooting
local SHOT_COOLDOWN = 0.5 -- Minimum time between shots

-- Global variables
local Character = nil
local HumanoidRootPart = nil
local ShootEvent = nil
local LastShot = 0

-- Function to initialize character
function initializeCharacter()
    Character = LocalPlayer.Character
    if Character then
        HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
        ShootEvent = Character:WaitForChild("Bow"):WaitForChild("ShootEvent")
        return true
    end
    return false
end

-- Function to calculate angle for shooting
function calculateShootAngle(startPos, targetPos)
    -- Get horizontal distance
    local horizontalDistance = (Vector3.new(targetPos.X, 0, targetPos.Z) - Vector3.new(startPos.X, 0, startPos.Z)).Magnitude
    local heightDifference = targetPos.Y - startPos.Y
    
    -- If horizontal distance is very small, use default angle
    if horizontalDistance < 1 then
        return 0.08856413333948392
    end
    
    -- Calculate angle based on height difference and distance
    local angle = math.atan(heightDifference / horizontalDistance)
    
    return angle
end

-- Function to shoot at position
function shootAtPosition(targetPos)
    if not ShootEvent or not Character or not HumanoidRootPart then
        return false
    end
    
    local currentTime = tick()
    if currentTime - LastShot < SHOT_COOLDOWN then
        return false
    end
    
    -- Calculate shooting angle
    local startPos = HumanoidRootPart.Position + Vector3.new(0, 2, 0) -- Shoot from chest height
    local angle = calculateShootAngle(startPos, targetPos)
    
    -- Fire the shoot event
    local args = {
        targetPos,
        angle
    }
    
    ShootEvent:FireServer(unpack(args))
    LastShot = currentTime
    
    return true
end

-- Function to find and shoot at closest player
function shootAtClosestPlayer()
    if not ShootEvent or not Character or not HumanoidRootPart then
        return false
    end
    
    local currentTime = tick()
    if currentTime - LastShot < SHOT_COOLDOWN then
        return false
    end
    
    -- Find closest player (no range limit)
    local closestPlayer = nil
    local closestDistance = math.huge
    local closestHRP = nil
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local distance = (targetHRP.Position - HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                    closestHRP = targetHRP
                end
            end
        end
    end
    
    if closestPlayer and closestHRP then
        -- Shoot at CURRENT position (no prediction)
        return shootAtPosition(closestHRP.Position)
    end
    
    return false
end

-- Character respawn handler
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    wait(0.5)
    initializeCharacter()
end)

-- Death handler
LocalPlayer.CharacterRemoving:Connect(function()
    Character = nil
    HumanoidRootPart = nil
    ShootEvent = nil
end)

-- Main loop to auto-shoot at closest player
RunService.Heartbeat:Connect(function()
    if not ShootEvent or not AUTO_SHOOT_ENABLED then
        return
    end
    
    local currentTime = tick()
    if currentTime - LastShot < SHOT_COOLDOWN then
        return
    end
    
    -- Find closest player
    local closestPlayer = nil
    local closestDistance = math.huge
    local closestHRP = nil
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and Character and HumanoidRootPart then
            local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local distance = (targetHRP.Position - HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                    closestHRP = targetHRP
                end
            end
        end
    end
    
    -- Shoot at closest player's CURRENT position
    if closestPlayer and closestHRP then
        shootAtPosition(closestHRP.Position)
    end
end)

-- Keybinds for manual control
local UserInputService = game:GetService("UserInputService")
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    -- Toggle auto-shoot with T key
    if input.KeyCode == Enum.KeyCode.T then
        AUTO_SHOOT_ENABLED = not AUTO_SHOOT_ENABLED
        print("Auto-shoot: " .. (AUTO_SHOOT_ENABLED and "ENABLED" or "DISABLED"))
    end
    
    -- Manual shoot at closest player with Q key
    if input.KeyCode == Enum.KeyCode.Q then
        shootAtClosestPlayer()
    end
    
    -- Manual aim and shoot at mouse position with E key
    if input.KeyCode == Enum.KeyCode.E then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Hit then
            shootAtPosition(mouse.Hit.Position)
        end
    end
    
    -- Force shoot at specific location with F key (for testing)
    if input.KeyCode == Enum.KeyCode.F and HumanoidRootPart then
        local forwardPos = HumanoidRootPart.Position + (HumanoidRootPart.CFrame.LookVector * 50)
        shootAtPosition(forwardPos)
    end
end)

-- Visual indicator for auto-shoot status
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BowAutoShootUI"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local StatusText = Instance.new("TextLabel")
StatusText.Name = "StatusText"
StatusText.Size = UDim2.new(0, 250, 0, 60)
StatusText.Position = UDim2.new(0.02, 0, 0.02, 0)
StatusText.BackgroundTransparency = 0.5
StatusText.BackgroundColor3 = Color3.new(0, 0, 0)
StatusText.TextColor3 = Color3.new(1, 1, 1)
StatusText.Text = "Bow Auto: ON\nTarget: CLOSEST PLAYER\nCooldown: Ready"
StatusText.Font = Enum.Font.SourceSansBold
StatusText.TextSize = 16
StatusText.TextXAlignment = Enum.TextXAlignment.Left
StatusText.TextYAlignment = Enum.TextYAlignment.Top
StatusText.Parent = ScreenGui

-- Target tracking display
local TargetInfo = Instance.new("TextLabel")
TargetInfo.Name = "TargetInfo"
TargetInfo.Size = UDim2.new(0, 250, 0, 80)
TargetInfo.Position = UDim2.new(0.02, 0, 0.12, 0)
TargetInfo.BackgroundTransparency = 0.7
TargetInfo.BackgroundColor3 = Color3.new(0, 0, 0)
TargetInfo.TextColor3 = Color3.new(1, 1, 1)
TargetInfo.Text = "No target"
TargetInfo.Font = Enum.Font.SourceSans
TargetInfo.TextSize = 14
TargetInfo.TextXAlignment = Enum.TextXAlignment.Left
TargetInfo.TextYAlignment = Enum.TextYAlignment.Top
TargetInfo.Parent = ScreenGui

-- Update UI
RunService.Heartbeat:Connect(function()
    -- Update status
    if AUTO_SHOOT_ENABLED then
        StatusText.Text = "Bow Auto: ON\nTarget: CLOSEST PLAYER"
        StatusText.TextColor3 = Color3.fromRGB(0, 255, 0)
    else
        StatusText.Text = "Bow Auto: OFF\nTarget: CLOSEST PLAYER"
        StatusText.TextColor3 = Color3.fromRGB(255, 100, 100)
    end
    
    -- Update cooldown
    local currentTime = tick()
    local remaining = SHOT_COOLDOWN - (currentTime - LastShot)
    if remaining > 0 then
        StatusText.Text = StatusText.Text .. string.format("\nCooldown: %.1fs", remaining)
    else
        StatusText.Text = StatusText.Text .. "\nCooldown: Ready"
    end
    
    -- Update target info
    if Character and HumanoidRootPart then
        local closestPlayer = nil
        local closestDistance = math.huge
        local closestHRP = nil
        
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
                if targetHRP then
                    local distance = (targetHRP.Position - HumanoidRootPart.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestPlayer = player
                        closestHRP = targetHRP
                    end
                end
            end
        end
        
        if closestPlayer and closestHRP then
            TargetInfo.Text = string.format("Target: %s\nDistance: %.1f studs\nMode: INSTANT SHOT\nLocation: %.1f, %.1f, %.1f",
                closestPlayer.Name,
                closestDistance,
                closestHRP.Position.X,
                closestHRP.Position.Y,
                closestHRP.Position.Z)
        else
            TargetInfo.Text = "No players found"
        end
    else
        TargetInfo.Text = "Character not loaded"
    end
end)

-- Initial setup
wait(1)
initializeCharacter()
print("==================== BOW AUTO-SHOOTER ====================")
print("Simplified Version - No Movement Prediction")
print("Features:")
print("- Attacks CLOSEST PLAYER (no range limit)")
print("- INSTANT SHOT at current position")
print("- Smart angle calculation")
print("- 0.5s shot cooldown")
print("")
print("Controls:")
print("T - Toggle auto-shoot ON/OFF")
print("Q - Manual shoot at closest player")
print("E - Shoot at mouse position")
print("F - Test shot forward")
print("=======================================================")
